DROP DATABASE MAB_TRACK;
CREATE DATABASE MAB_TRACK;

CONNECT MAB_TRACK;

CREATE TABLE aca (
  Aca_ID INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
  ACA_Name CHAR(50) NOT NULL,
  ACA_Bname CHAR(50) NOT NULL
);
CREATE TABLE aca_user (
  User_ID INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
  Aca_ID INT UNSIGNED NOT NULL,
  Fname CHAR(50) NOT NULL,
  Lname CHAR(50) NOT NULL,
  Type SET('CUSTOMER', 'ADMINISTRATOR') NOT NULL,
  FOREIGN KEY (Aca_ID) REFERENCES aca (Aca_ID)
);
CREATE TABLE aca_user_password (
  User_ID INT UNSIGNED NOT NULL,
  Password CHAR(42) NOT NULL,
  PRIMARY KEY (User_ID),
  FOREIGN KEY (User_ID) REFERENCES aca_user (User_ID)
);
CREATE TABLE aca_mab (
  Mac_ID BIGINT UNSIGNED NOT NULL,
  Valid_From DATETIME DEFAULT CURRENT_TIMESTAMP,
  Valid_Until DATETIME DEFAULT '1000-01-01 00:00:00' ON UPDATE CURRENT_TIMESTAMP,
  Aca_ID INT UNSIGNED NOT NULL,
  User_ID INT UNSIGNED NOT NULL,
  State SET('ACTIVE', 'PASSIVE') NOT NULL,
  Ticket VARCHAR(20) NOT NULL,
  PRIMARY KEY (Mac_ID,Valid_From,Valid_Until),
  FOREIGN KEY (Aca_ID) REFERENCES aca (Aca_ID),
  FOREIGN KEY (User_ID) REFERENCES aca_user (User_ID)
);
CREATE TABLE aca_mab_metadata (
  Mac_ID BIGINT UNSIGNED NOT NULL,
  Note VARCHAR (1000)DEFAULT NULL,
  Action INT(100) UNSIGNED NOT NULL,
  PRIMARY KEY (Mac_ID),
  FOREIGN KEY (Mac_ID) REFERENCES aca_mab (Mac_ID)
);

INSERT INTO aca VALUES(NULL,"FPI","AGAWAM");
INSERT INTO aca VALUES(NULL,"NWFCS","SPOKANE");
INSERT INTO aca VALUES(NULL,"FCE","WINDSOR");
INSERT INTO aca_user VALUES(NULL,1,"EROU","FOSTER","ADMINISTRATOR");
INSERT INTO aca_user VALUES(NULL,2,"FRED","FLINTSTONE","CUSTOMER");
INSERT INTO aca_user VALUES(NULL,2,"CHARLEY","MURPHY","CUSTOMER");
INSERT INTO aca_user VALUES(NULL,3,"DONALD","TRUMP","CUSTOMER");
INSERT INTO aca_user VALUES(NULL,3,"DAVID","NEILL","CUSTOMER");
INSERT INTO aca_user VALUES(NULL,2,"KENDRICK","LAMAR","CUSTOMER");
INSERT INTO aca_user VALUES(NULL,3,"SAM","ADAMS","CUSTOMER");
INSERT INTO aca_user VALUES(NULL,1,"FROSTY","FACE","CUSTOMER");
INSERT INTO aca_user VALUES(NULL,2,"WOODY","GUTHRIE","CUSTOMER");
INSERT INTO aca_user VALUES(NULL,1,"JOSEPH","AUDET","ADMINISTRATOR");
INSERT INTO aca_user_password VALUES(1,"e38ad214943daad1d64c102faec29de4afe9da3d");
INSERT INTO aca_user_password VALUES(2,"e38ad214943daad1d64c102faec29de4afe9da3d");
INSERT INTO aca_user_password VALUES(10,"e38ad214943daad1d64c102faec29de4afe9da3d");
INSERT INTO aca_mab (Mac_ID, Aca_ID, User_ID, State, Ticket) VALUES(18764998447377,2,2,"ACTIVE","INC0229085");
INSERT INTO aca_mab (Mac_ID, Aca_ID, User_ID, State, Ticket) VALUES(64579898907324,2,3,"ACTIVE","INC0228916");
INSERT INTO aca_mab (Mac_ID, Aca_ID, User_ID, State, Ticket) VALUES(206371746349055,3,4,"ACTIVE","INC0228339");
INSERT INTO aca_mab (Mac_ID, Aca_ID, User_ID, State, Ticket) VALUES(177871106557727,3,5,"ACTIVE","INC0225070");
INSERT INTO aca_mab (Mac_ID, Aca_ID, User_ID, State, Ticket) VALUES(31999624755866,2,6,"ACTIVE","INC0225190");
INSERT INTO aca_mab (Mac_ID, Aca_ID, User_ID, State, Ticket) VALUES(27618687937945,3,7,"ACTIVE","INC0224868");
INSERT INTO aca_mab (Mac_ID, Aca_ID, User_ID, State, Ticket) VALUES(205462290820849,1,8,"ACTIVE","INC0224709");
INSERT INTO aca_mab (Mac_ID, Aca_ID, User_ID, State, Ticket) VALUES(150244117114491,2,9,"ACTIVE","INC0225111");
INSERT INTO aca_mab (Mac_ID, Aca_ID, User_ID, State, Ticket) VALUES(35490518732683,1,10,"ACTIVE","INC0229598");
INSERT INTO aca_mab_metadata VALUES(18764998447377,"THIS IS THE FIRST NOTE FOR THE FIRST MAC",1);
INSERT INTO aca_mab_metadata VALUES(64579898907324,"THIS IS THE FIRST NOTE FOR THE SECOND MAC",1);
INSERT INTO aca_mab_metadata VALUES(206371746349055,"THIS IS THE FIRST NOTE FOR THE THRID MAC",1);
INSERT INTO aca_mab_metadata VALUES(177871106557727,"THIS IS THE FIRST NOTE FOR THE FORTH MAC",1);
INSERT INTO aca_mab_metadata VALUES(31999624755866,"THIS IS THE FIRST NOTE FOR THE FIFTH MAC",1);
INSERT INTO aca_mab_metadata VALUES(27618687937945,"THIS IS THE FIRST NOTE FOR THE SIXTH MAC",1);
INSERT INTO aca_mab_metadata VALUES(205462290820849,"THIS IS THE FIRST NOTE FOR THE SEVENTH MAC",1);
INSERT INTO aca_mab_metadata VALUES(150244117114491,"THIS IS THE FIRST NOTE FOR THE EIGHTH MAC",1);
INSERT INTO aca_mab_metadata VALUES(35490518732683,"THIS IS THE FIRST NOTE FOR THE NINTH MAC",10);


UPDATE aca_mab SET Valid_Until = now() WHERE Mac_ID = 18764998447377;
INSERT INTO aca_mab (Mac_ID, Aca_ID, User_ID, State, Ticket) VALUES(18764998447377,2,2,"PASSIVE","INC0229085");

UPDATE aca_mab SET Valid_Until = now() WHERE Mac_ID = 64579898907324;
INSERT INTO aca_mab (Mac_ID, Aca_ID, User_ID, State, Ticket) VALUES(64579898907324,2,3,"PASSIVE","INC0228916");

UPDATE aca_mab SET Valid_Until = now() WHERE Mac_ID = 64579898907324;
INSERT INTO aca_mab (Mac_ID, Aca_ID, User_ID, State, Ticket) VALUES(64579898907324,2,3,"ACTIVE","INC0228916");
UPDATE aca_mab_metadata SET Action = Action + 1 WHERE Mac_ID = 64579898907324;


# GETS THE ADMIN HISTORY FOR ALL MACS  



# GETS THE USER HISTORY FOR ALL MACS      
SELECT am.Mac_ID, au.Fname, au.Lname, a.ACA_Name, a.ACA_Bname, am.Valid_From, am.State
FROM aca_mab as am
JOIN aca_user as au
USING (User_ID)
JOIN aca as a
ON a.Aca_ID = au.Aca_ID
WHERE am.Valid_Until != '1000-01-01 00:00:00'
ORDER BY am.Valid_From ASC;
      
# GETS THE ADMIN FOR ALL MACS    
 

# GETS THE USER FOR ALL MACS      
SELECT am.Mac_ID, au.Fname, au.Lname, a.ACA_Name, a.ACA_Bname, am.Valid_From, am.State, amm.Action, am.Ticket
FROM aca_mab as am
JOIN aca_user as au
USING (User_ID)
JOIN aca as a
ON a.Aca_ID = au.Aca_ID
JOIN aca_mab_metadata as amm
ON am.Mac_ID = amm.Mac_ID
WHERE am.Valid_Until = '1000-01-01 00:00:00'
ORDER BY am.Valid_From ASC;

      
# GETS THE ADMIN AND THE USER FOR ALL MACS

# GETS THE NOTES AND for a Particular MAC
SELECT amm.Mac_ID, amm.Note, amm.Ticket
FROM aca_mab_metadata as amm
WHERE amm.Mac_ID = 31999624755866
ORDER BY amm.Mac_ID ASC;

# GETS A SINGLE ROW BASES ON USER NAME
SELECT am.Mac_ID, au.Fname, au.Lname, a.ACA_Name, a.ACA_Bname, am.Valid_From, am.State, amm.Action, am.Ticket
FROM aca_mab as am
JOIN aca_user as au
USING (User_ID)
JOIN aca as a
ON a.Aca_ID = au.Aca_ID
JOIN aca_mab_metadata as amm
ON am.Mac_ID = amm.Mac_ID
WHERE am.Valid_Until = '1000-01-01 00:00:00' AND   CONCAT( Fname,  ' ', Lname ) LIKE  '%Jo%'
ORDER BY am.Valid_From ASC;

# GETS A SINGLE ROW BASES ON MAC ADDRESS
SELECT am.Mac_ID, au.Fname, au.Lname, a.ACA_Name, a.ACA_Bname, am.Valid_From, am.State, amm.Action
FROM aca_mab as am
JOIN aca_user as au
USING (User_ID)
JOIN aca as a
ON a.Aca_ID = au.Aca_ID
JOIN aca_mab_metadata as amm
ON am.Mac_ID = amm.Mac_ID
WHERE am.Valid_Until = '1000-01-01 00:00:00' AND  am.Mac_ID LIKE '%150244117114491%'
ORDER BY am.Valid_From ASC;

# GETS DETAILED INFORMATION ON USER NAME RETURNS A SINGLE ROW
SELECT au.User_ID, au.Fname, au.Lname, a.Aca_ID, a.ACA_Name, a.ACA_Bname
FROM aca_user as au
JOIN aca as a
ON a.Aca_ID = au.Aca_ID
WHERE CONCAT( Fname,  ' ', Lname ) = "SAM ADAMS";

# GETS A SINGLE NOTE BASES ON MAC ADDRESS
SELECT amm.Mac_ID, amm.Note, amm.Action, am.Ticket
FROM aca_mab_metadata as amm
JOIN aca_mab as am
USING (Mac_ID)
WHERE am.Valid_Until = '1000-01-01 00:00:00' AND amm.Mac_ID = 18764998447377
ORDER BY amm.Mac_ID ASC;


# GETS A COUNT OF ENTIRE MAC TABLE (ACTIVE OR PASSIVE EXCLUDING ROWS SET VALID_UNTIL)
SELECT COUNT(*)
FROM aca_mab as am
WHERE am.Valid_Until = '1000-01-01 00:00:00'


# PROCEDURE TO ADD A MAC
DELIMITER //
CREATE PROCEDURE add_mac
(IN PROC_Aca_ID INT, IN PROC_Fname CHAR(50), IN PROC_Lname CHAR(50), IN PROC_Mac_ID BIGINT, IN PROC_Ticket VARCHAR(20))
BEGIN
DECLARE PROC_Type SET('CUSTOMER', 'ADMINISTRATOR');
DECLARE PROC_State SET('ACTIVE', 'PASSIVE');
DECLARE PROC_User_ID INT;
DECLARE PROC_Note VARCHAR(1000);
DECLARE PROC_Action  INT(100);
SET PROC_Type = 'CUSTOMER';
SET PROC_State = 'ACTIVE';
SET PROC_Note = 'GENERIC PROCEDURAL NOTE';
SET PROC_Action = 1;

INSERT INTO aca_user (Aca_ID, Fname, Lname, Type) VALUES (PROC_Aca_ID, PROC_Fname, PROC_Lname, PROC_Type);
SELECT User_ID INTO PROC_User_ID FROM aca_user WHERE Aca_ID = PROC_Aca_ID AND Fname = PROC_Fname AND Lname = PROC_Lname AND Type = PROC_Type;
INSERT INTO aca_mab (Mac_ID, Aca_ID, User_ID, State, Ticket) VALUES(PROC_Mac_ID, PROC_Aca_ID, PROC_User_ID, PROC_State,PROC_Ticket);
INSERT INTO aca_mab_metadata VALUES(PROC_Mac_ID,PROC_Note,PROC_Action);
END //
DELIMITER ;


# PROCEDURE TO ADD A User AND update MAC tables
DELIMITER //
CREATE PROCEDURE add_user_update_mac
(IN PROC_Aca_ID INT, IN PROC_Fname CHAR(50), IN PROC_Lname CHAR(50), IN PROC_Mac_ID BIGINT, IN PROC_Ticket VARCHAR(20))
BEGIN
DECLARE PROC_Type SET('CUSTOMER', 'ADMINISTRATOR');
DECLARE PROC_State SET('ACTIVE', 'PASSIVE');
DECLARE PROC_User_ID INT;
DECLARE PROC_Note VARCHAR(1000);
DECLARE PROC_Action  INT(100);
SET PROC_Type = 'CUSTOMER';
SET PROC_State = 'ACTIVE';
SET PROC_Note = 'GENERIC PROCEDURAL NOTE';
SET PROC_Action = 1;
INSERT INTO aca_user (Aca_ID, Fname, Lname, Type) VALUES (PROC_Aca_ID, PROC_Fname, PROC_Lname, PROC_Type);
SELECT User_ID INTO PROC_User_ID FROM aca_user WHERE Aca_ID = PROC_Aca_ID AND Fname = PROC_Fname AND Lname = PROC_Lname AND Type = PROC_Type;
UPDATE aca_mab SET Valid_Until = now() WHERE Mac_ID = PROC_Mac_ID;
INSERT INTO aca_mab (Mac_ID, Aca_ID, User_ID, State, Ticket) VALUES(PROC_Mac_ID, PROC_Aca_ID, PROC_User_ID, PROC_State, PROC_Ticket);
UPDATE aca_mab_metadata SET Action = PROC_Action WHERE Mac_ID = PROC_Mac_ID;
END //
DELIMITER ;


CALL add_mac (1,'CAT','DOG','88888888',999999999)
 CALL add_user_update_mac (3,'HYPER','BEAST',18764998447377,'INC0233335');

DELETE FROM aca_user WHERE Fname = 'CAT';

SHOW PROCEDURE STATUS;
SHOW CREATE PROCEDURE add_mac;
DROP PROCEDURE add_mac;
